#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use EpgAggregator\Store\SqliteConnectionFactory;
use EpgAggregator\Store\SchemaManager;
use EpgAggregator\Store\ChannelRepository;
use EpgAggregator\Store\ProgramRepository;
use EpgAggregator\Store\SettingsRepository;
use EpgAggregator\Ingest\Source1Client;        // ak sa volá SourceClient.php
use EpgAggregator\Parse\Source1Parser;
use EpgAggregator\Normalize\Source1Normalizer;
use EpgAggregator\Domain\Program;
use EpgAggregator\Export\XmltvExporter;
use EpgAggregator\Export\JsonExporter;

$argvCopy = $argv;
array_shift($argvCopy); // zahodíme názov skriptu

$command = $argvCopy[0] ?? null;

// cesta k SQLite DB
$varDir = __DIR__ . '/../var';
if (!is_dir($varDir)) {
    mkdir($varDir, 0777, true);
}
$dbPath = $varDir . '/epg.sqlite';

// pripojenie + schema manager
$connectionFactory = new SqliteConnectionFactory($dbPath);
$pdo               = $connectionFactory->create();
$schemaManager     = new SchemaManager($pdo);

$channelRepo = new ChannelRepository($pdo);
$programRepo = new ProgramRepository($pdo);
$settingsRepo = new SettingsRepository($pdo);

switch ($command) {
    case 'migrate':
        $schemaManager->ensureSchema();
        echo "Database schema ensured at {$dbPath}\n";
        break;

    case 'import':
        $source = $argvCopy[1] ?? null;
        $path   = $argvCopy[2] ?? null;

        if ($source !== 'source1' || $path === null) {
            fwrite(STDERR, "Usage: epg import source1 /path/to/source1.xml[.gz]\n");
            exit(1);
        }

        $schemaManager->ensureSchema();

        $client = new Source1Client($path);
        $raw    = $client->fetch();

        $parser = new Source1Parser();
        $parsed = $parser->parse($raw);

        $normalizer = new Source1Normalizer();
        $normalized = $normalizer->normalize($parsed, 'source1');

        // persist channels
        $channelsByXmltvId = [];
        foreach ($normalized->channels as $ch) {
            $saved = $channelRepo->upsert($ch);
            if ($saved->id === null) {
                continue;
            }
            $channelsByXmltvId[$saved->xmltvId] = $saved;
        }

        $inserted         = 0;
        $skippedNoChannel = 0;
        $skippedDuplicate = 0;

        foreach ($normalized->programs as $np) {
            if (!isset($channelsByXmltvId[$np->channelXmltvId])) {
                $skippedNoChannel++;
                continue;
            }

            $channel = $channelsByXmltvId[$np->channelXmltvId];

            $program = new Program(
                id: null,
                channelId: $channel->id,
                title: $np->title,
                subtitle: $np->subtitle,
                description: $np->description,
                startUtc: $np->startUtc,
                endUtc: $np->endUtc,
                source: $np->source,
                sourceProgramId: $np->sourceProgramId,
                dedupKey: $np->dedupKey,
            );

            $saved = $programRepo->insertIgnoreDuplicate($program);
            if ($saved === null) {
                $skippedDuplicate++;
            } else {
                $inserted++;
            }
        }

        echo "Import from source1 finished.\n";
        echo "  programs inserted:    {$inserted}\n";
        echo "  skipped (no channel): {$skippedNoChannel}\n";
        echo "  skipped (duplicates): {$skippedDuplicate}\n";
        break;

    case 'master':
        $sub = $argvCopy[1] ?? null;

        if ($sub === 'apply') {
            $filePath = $argvCopy[2] ?? null;
            if ($filePath === null) {
                fwrite(STDERR, "Usage: epg master apply /path/to/master-list.txt\n");
                exit(1);
            }
            if (!is_file($filePath)) {
                fwrite(STDERR, "Master list file not found: {$filePath}\n");
                exit(1);
            }

            $text = trim((string) file_get_contents($filePath));

            // rollback buffer
            $current = $settingsRepo->get('master_channels_text_current');
            if ($current !== null) {
                $settingsRepo->set('master_channels_text_prev', $current);
            }
            $settingsRepo->set('master_channels_text_current', $text);

            $lines = preg_split('/\R/', $text);
            $names = [];
            foreach ($lines as $line) {
                $name = trim($line);
                if ($name !== '') {
                    $names[] = $name;
                }
            }

            $channelRepo->updateMasterFromList($names);

            echo "Master list applied (" . count($names) . " channels).\n";
            break;
        }

        if ($sub === 'rollback') {
            $prev = $settingsRepo->get('master_channels_text_prev');
            if ($prev === null) {
                fwrite(STDERR, "No previous master list to rollback to.\n");
                exit(1);
            }

            $settingsRepo->set('master_channels_text_current', $prev);

            $lines = preg_split('/\R/', $prev);
            $names = [];
            foreach ($lines as $line) {
                $name = trim($line);
                if ($name !== '') {
                    $names[] = $name;
                }
            }

            $channelRepo->updateMasterFromList($names);

            echo "Master list rollback applied (" . count($names) . " channels).\n";
            break;
        }

        fwrite(STDERR, "Usage:\n");
        fwrite(STDERR, "  epg master apply /path/to/master-list.txt\n");
        fwrite(STDERR, "  epg master rollback\n");
        exit(1);

    case 'export':
        $format = $argvCopy[1] ?? null;
        $path   = $argvCopy[2] ?? null;

        if ($format === null || $path === null) {
            fwrite(STDERR, "Usage:\n");
            fwrite(STDERR, "  epg export xmltv /path/to/epg.xml[.gz]\n");
            fwrite(STDERR, "  epg export json  /path/to/epg.json\n");
            exit(1);
        }

        $schemaManager->ensureSchema();

        if ($format === 'xmltv') {
            $exporter = new XmltvExporter($channelRepo, $programRepo);
            $exporter->export($path);
            echo "XMLTV exported to {$path}\n";
        } elseif ($format === 'json') {
            $exporter = new JsonExporter($channelRepo, $programRepo);
            $exporter->export($path);
            echo "JSON exported to {$path}\n";
        } else {
            fwrite(STDERR, "Unknown export format: {$format}\n");
            exit(1);
        }
        break;

    default:
        echo "EPG Aggregator CLI\n";
        echo "Usage:\n";
        echo "  epg migrate                          Initialize/update SQLite schema\n";
        echo "  epg import source1 file.xml[.gz]     Import XMLTV file from source1\n";
        echo "  epg export xmltv epg.xml[.gz]        Export DB as XMLTV\n";
        echo "  epg export json  epg.json            Export DB as JSON\n";
        echo "  epg master apply master.txt          Apply master channel list from text file\n";
        echo "  epg master rollback                  Rollback to previous master list\n";
        exit(0);
}
