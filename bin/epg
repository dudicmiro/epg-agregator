#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use EpgAggregator\Store\SqliteConnectionFactory;
use EpgAggregator\Store\SchemaManager;
use EpgAggregator\Store\ChannelRepository;
use EpgAggregator\Store\ProgramRepository;
use EpgAggregator\Store\SettingsRepository;
use EpgAggregator\Ingest\Source1Client;
use EpgAggregator\Parse\Source1Parser;
use EpgAggregator\Normalize\Source1Normalizer;
use EpgAggregator\Domain\Program;
use EpgAggregator\Export\XmltvExporter;
use EpgAggregator\Export\JsonExporter;
use EpgAggregator\Export\ChannelsJsonExporter;

$argvCopy = $argv;
array_shift($argvCopy); // zahodíme názov skriptu

$command = $argvCopy[0] ?? null;

// cesta k SQLite DB
$varDir = __DIR__ . '/../var';
if (!is_dir($varDir)) {
    mkdir($varDir, 0777, true);
}
$dbPath = $varDir . '/epg.sqlite';

// pripojenie + schema manager
$connectionFactory = new SqliteConnectionFactory($dbPath);
$pdo               = $connectionFactory->create();
$schemaManager     = new SchemaManager($pdo);

$channelRepo = new ChannelRepository($pdo);
$programRepo = new ProgramRepository($pdo);
$settingsRepo = new SettingsRepository($pdo);

switch ($command) {
    case 'migrate':
        $schemaManager->ensureSchema();
        echo "Database schema ensured at {$dbPath}\n";
        break;

    case 'import':
        $source = $argvCopy[1] ?? null;
        $path   = $argvCopy[2] ?? null;

        if ($source !== 'source1' || $path === null) {
            fwrite(STDERR, "Usage: epg import source1 /path/to/source1.xml[.gz]\n");
            exit(1);
        }

        $schemaManager->ensureSchema();

        $client = new Source1Client($path);
        $raw    = $client->fetch();

        $parser = new Source1Parser();
        $parsed = $parser->parse($raw);

        $normalizer = new Source1Normalizer();
        $normalized = $normalizer->normalize($parsed, 'source1');

        // persist channels
        $channelsByXmltvId = [];
        foreach ($normalized->channels as $ch) {
            $saved = $channelRepo->upsert($ch);
            if ($saved->id === null) {
                continue;
            }
            $channelsByXmltvId[$saved->xmltvId] = $saved;
        }

        $inserted         = 0;
        $skippedNoChannel = 0;
        $skippedDuplicate = 0;

        foreach ($normalized->programs as $np) {
            if (!isset($channelsByXmltvId[$np->channelXmltvId])) {
                $skippedNoChannel++;
                continue;
            }

            $channel = $channelsByXmltvId[$np->channelXmltvId];

            $program = new Program(
                id: null,
                channelId: $channel->id,
                title: $np->title,
                subtitle: $np->subtitle,
                description: $np->description,
                startUtc: $np->startUtc,
                endUtc: $np->endUtc,
                source: $np->source,
                sourceProgramId: $np->sourceProgramId,
                dedupKey: $np->dedupKey,
            );

            $saved = $programRepo->insertIgnoreDuplicate($program);
            if ($saved === null) {
                $skippedDuplicate++;
            } else {
                $inserted++;
            }
        }

        echo "Import from source1 finished.\n";
        echo "  programs inserted:    {$inserted}\n";
        echo "  skipped (no channel): {$skippedNoChannel}\n";
        echo "  skipped (duplicates): {$skippedDuplicate}\n";
        break;

    case 'master':
        $sub = $argvCopy[1] ?? null;

        if ($sub === 'apply') {
            $filePath = $argvCopy[2] ?? null;
            if ($filePath === null) {
                fwrite(STDERR, "Usage: epg master apply /path/to/master-list.txt\n");
                exit(1);
            }
            if (!is_file($filePath)) {
                fwrite(STDERR, "Master list file not found: {$filePath}\n");
                exit(1);
            }

            $text = trim((string) file_get_contents($filePath));

            // rollback buffer
            $current = $settingsRepo->get('master_channels_text_current');
            if ($current !== null) {
                $settingsRepo->set('master_channels_text_prev', $current);
            }
            $settingsRepo->set('master_channels_text_current', $text);

            $lines = preg_split('/\R/', $text);
            $names = [];
            foreach ($lines as $line) {
                $name = trim($line);
                if ($name !== '') {
                    $names[] = $name;
                }
            }

            $channelRepo->updateMasterFromList($names);

            echo "Master list applied (" . count($names) . " channels).\n";
            break;
        }

        if ($sub === 'rollback') {
            $prev = $settingsRepo->get('master_channels_text_prev');
            if ($prev === null) {
                fwrite(STDERR, "No previous master list to rollback to.\n");
                exit(1);
            }

            $settingsRepo->set('master_channels_text_current', $prev);

            $lines = preg_split('/\R/', $prev);
            $names = [];
            foreach ($lines as $line) {
                $name = trim($line);
                if ($name !== '') {
                    $names[] = $name;
                }
            }

            $channelRepo->updateMasterFromList($names);

            echo "Master list rollback applied (" . count($names) . " channels).\n";
            break;
        }

        fwrite(STDERR, "Usage:\n");
        fwrite(STDERR, "  epg master apply /path/to/master-list.txt\n");
        fwrite(STDERR, "  epg master rollback\n");
        exit(1);

    case 'export':
        $format = $argvCopy[1] ?? null;
        $path   = $argvCopy[2] ?? null;

        if ($format === null || $path === null) {
            fwrite(STDERR, "Usage: epg export [xmltv|json|channels-json] output-path\n");
            exit(1);
        }

        // vždy sa uistíme, že schema existuje
        $schemaManager->ensureSchema();

        if ($format === 'xmltv') {
            $exporter = new XmltvExporter($channelRepo, $programRepo);
            $exporter->export($path);
            echo "XMLTV exported to {$path}\n";
            break;
        }

        if ($format === 'json') {
            $exporter = new JsonExporter($channelRepo, $programRepo);
            $exporter->export($path);
            echo "JSON exported to {$path}\n";
            break;
        }

        if ($format === 'channels-json') {
            $exporter = new ChannelsJsonExporter($channelRepo);
            $exporter->export($path);
            // exporter už vypíše hlášku
            break;
        }

        fwrite(STDERR, "Unknown export format: {$format}\n");
        exit(1);

    case 'channels':
        $filter = $argvCopy[1] ?? 'all';

        if ($filter === 'all') {
            $where = '';
        } elseif ($filter === 'master') {
            $where = 'WHERE c.is_master = 1';
        } else {
            fwrite(STDERR, "Usage: epg channels [all|master]\n");
            exit(1);
        }

        $sql = '
            SELECT
                c.id,
                c.xmltv_id,
                c.name,
                c.is_master,
                c.position,
                COUNT(p.id) AS program_count
            FROM channels c
            LEFT JOIN programs p ON p.channel_id = c.id
            ' . $where . '
            GROUP BY c.id, c.xmltv_id, c.name, c.is_master, c.position
            ORDER BY
                CASE WHEN c.is_master = 1 THEN 0 ELSE 1 END,
                COALESCE(c.position, 999999),
                c.name
        ';

        $stmt = $pdo->query($sql);

        // hlavička
        printf("%-4s %-40s %-30s %-6s %-8s %-8s\n",
            'ID', 'NAME', 'XMLTV_ID', 'MASTER', 'POS', 'PROGRAMS'
        );
        printf("%'-4s %'-40s %'-30s %'-6s %'-8s %'-8s\n",
            '', '', '', '', '', ''
        );

        while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) {
            printf(
                "%-4d %-40s %-30s %-6s %-8s %-8d\n",
                $row['id'],
                substr($row['name'], 0, 40),
                substr($row['xmltv_id'], 0, 30),
                $row['is_master'] ? 'yes' : 'no',
                $row['position'] === null ? '-' : $row['position'],
                $row['program_count']
            );
        }

        break;

    default:
        echo "EPG Aggregator CLI\n";
        echo "Usage:\n";
        echo "  epg migrate                          Initialize/update SQLite schema\n";
        echo "  epg import source1 file.xml[.gz]     Import XMLTV file from source1\n";
        echo "  epg export xmltv epg.xml[.gz]        Export DB as XMLTV\n";
        echo "  epg export json  epg.json            Export DB as JSON\n";
        echo "  epg master apply master.txt          Apply master channel list from text file\n";
        echo "  epg master rollback                  Rollback to previous master list\n";
        echo "  epg channels [all|master]            List channels with program counts\n";
        echo "  epg export channels-json file.json   Export master channels as HLS-Proxy style JSON\n";

        
        exit(0);
}
